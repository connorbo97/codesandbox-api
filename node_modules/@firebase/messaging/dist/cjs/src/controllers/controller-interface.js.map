{"version":3,"sources":["../src/controllers/controller-interface.ts"],"names":[],"mappings":"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","file":"controller-interface.js","sourcesContent":["/**\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n'use strict';\n\nimport { ErrorFactory } from '@firebase/util';\nimport Errors from '../models/errors';\nimport TokenDetailsModel from '../models/token-details-model';\nimport VapidDetailsModel from '../models/vapid-details-model';\nimport NOTIFICATION_PERMISSION from '../models/notification-permission';\nimport IIDModel from '../models/iid-model';\nimport arrayBufferToBase64 from '../helpers/array-buffer-to-base64';\n\nconst SENDER_ID_OPTION_NAME = 'messagingSenderId';\n// Database cache should be invalidated once a week.\nexport const TOKEN_EXPIRATION_MILLIS = 7 * 24 * 60 * 60 * 1000; // 7 days\n\nexport default class ControllerInterface {\n  public app;\n  public INTERNAL;\n  protected errorFactory_;\n  private messagingSenderId_: string;\n  private tokenDetailsModel_: TokenDetailsModel;\n  private vapidDetailsModel_: VapidDetailsModel;\n  private iidModel_: IIDModel;\n\n  /**\n   * An interface of the Messaging Service API\n   * @param {!firebase.app.App} app\n   */\n  constructor(app) {\n    this.errorFactory_ = new ErrorFactory('messaging', 'Messaging', Errors.map);\n\n    if (\n      !app.options[SENDER_ID_OPTION_NAME] ||\n      typeof app.options[SENDER_ID_OPTION_NAME] !== 'string'\n    ) {\n      throw this.errorFactory_.create(Errors.codes.BAD_SENDER_ID);\n    }\n\n    this.messagingSenderId_ = app.options[SENDER_ID_OPTION_NAME];\n\n    this.tokenDetailsModel_ = new TokenDetailsModel();\n    this.vapidDetailsModel_ = new VapidDetailsModel();\n    this.iidModel_ = new IIDModel();\n\n    this.app = app;\n    this.INTERNAL = {};\n    this.INTERNAL.delete = () => this.delete();\n  }\n\n  /**\n   * @export\n   */\n  getToken(): Promise<string | null> {\n    // Check with permissions\n    const currentPermission = this.getNotificationPermission_();\n    if (currentPermission !== NOTIFICATION_PERMISSION.granted) {\n      if (currentPermission === NOTIFICATION_PERMISSION.denied) {\n        return Promise.reject(\n          this.errorFactory_.create(Errors.codes.NOTIFICATIONS_BLOCKED)\n        );\n      }\n\n      // We must wait for permission to be granted\n      return Promise.resolve(null);\n    }\n    let swReg: ServiceWorkerRegistration;\n    return this.getSWRegistration_()\n      .then(reg => {\n        swReg = reg;\n        return this.tokenDetailsModel_.getTokenDetailsFromSWScope(swReg.scope);\n      })\n      .then(tokenDetails => {\n        if (tokenDetails) {\n          return this.manageExistingToken(tokenDetails, swReg);\n        }\n        return this.getNewToken(swReg);\n      });\n  }\n\n  /**\n   * manageExistingToken is triggered if there's an existing FCM token in the\n   * database and it can take 3 different actions:\n   * 1) Retrieve the existing FCM token from the database.\n   * 2) If VAPID details have changed: Delete the existing token and create a\n   * new one with the new VAPID key.\n   * 3) If the database cache is invalidated: Send a request to FCM to update\n   * the token, and to check if the token is still valid on FCM-side.\n   */\n  private manageExistingToken(\n    tokenDetails: Object,\n    swReg: ServiceWorkerRegistration\n  ): Promise<string> {\n    return this.isTokenStillValid(tokenDetails).then(isValid => {\n      if (isValid) {\n        const now = Date.now();\n        if (now < tokenDetails['createTime'] + TOKEN_EXPIRATION_MILLIS) {\n          return tokenDetails['fcmToken'];\n        } else {\n          return this.updateToken(tokenDetails, swReg);\n        }\n      } else {\n        // If the VAPID details are updated, delete the existing token,\n        // and create a new one.\n        return this.deleteToken(tokenDetails['fcmToken']).then(() => {\n          return this.getNewToken(swReg);\n        });\n      }\n    });\n  }\n\n  /*\n   * Checks if the tokenDetails match the details provided in the clients.\n   */\n  private isTokenStillValid(tokenDetails: Object): Promise<Boolean> {\n    // TODO Validate rest of the details.\n    return this.getPublicVapidKey_().then(publicKey => {\n      if (arrayBufferToBase64(publicKey) !== tokenDetails['vapidKey']) {\n        return false;\n      }\n      return true;\n    });\n  }\n\n  private updateToken(\n    tokenDetails: Object,\n    swReg: ServiceWorkerRegistration\n  ): Promise<string> {\n    let publicVapidKey: Uint8Array;\n    let updatedToken: string;\n    let subscription: PushSubscription;\n    return this.getPublicVapidKey_()\n      .then(publicKey => {\n        publicVapidKey = publicKey;\n        return this.getPushSubscription_(swReg, publicVapidKey);\n      })\n      .then(pushSubscription => {\n        subscription = pushSubscription;\n        return this.iidModel_.updateToken(\n          this.messagingSenderId_,\n          tokenDetails['fcmToken'],\n          tokenDetails['fcmPushSet'],\n          subscription,\n          publicVapidKey\n        );\n      })\n      .catch(err => {\n        return this.deleteToken(tokenDetails['fcmToken']).then(() => {\n          throw err;\n        });\n      })\n      .then(token => {\n        updatedToken = token;\n        const allDetails = {\n          swScope: swReg.scope,\n          vapidKey: publicVapidKey,\n          subscription: subscription,\n          fcmSenderId: this.messagingSenderId_,\n          fcmToken: updatedToken,\n          fcmPushSet: tokenDetails['fcmPushSet']\n        };\n        return this.tokenDetailsModel_.saveTokenDetails(allDetails);\n      })\n      .then(() => {\n        return this.vapidDetailsModel_.saveVapidDetails(\n          swReg.scope,\n          publicVapidKey\n        );\n      })\n      .then(() => {\n        return updatedToken;\n      });\n  }\n\n  private getNewToken(swReg: ServiceWorkerRegistration): Promise<string> {\n    let publicVapidKey: Uint8Array;\n    let subscription: PushSubscription;\n    let tokenDetails: Object;\n    return this.getPublicVapidKey_()\n      .then(publicKey => {\n        publicVapidKey = publicKey;\n        return this.getPushSubscription_(swReg, publicVapidKey);\n      })\n      .then(pushSubscription => {\n        subscription = pushSubscription;\n        return this.iidModel_.getToken(\n          this.messagingSenderId_,\n          subscription,\n          publicVapidKey\n        );\n      })\n      .then(iidTokenDetails => {\n        tokenDetails = iidTokenDetails;\n        const allDetails = {\n          swScope: swReg.scope,\n          vapidKey: publicVapidKey,\n          subscription: subscription,\n          fcmSenderId: this.messagingSenderId_,\n          fcmToken: tokenDetails['token'],\n          fcmPushSet: tokenDetails['pushSet']\n        };\n        return this.tokenDetailsModel_.saveTokenDetails(allDetails);\n      })\n      .then(() => {\n        return this.vapidDetailsModel_.saveVapidDetails(\n          swReg.scope,\n          publicVapidKey\n        );\n      })\n      .then(() => {\n        return tokenDetails['token'];\n      });\n  }\n\n  /**\n   * This method deletes tokens that the token manager looks after,\n   * unsubscribes the token from FCM  and then unregisters the push\n   * subscription if it exists. It returns a promise that indicates\n   * whether or not the unsubscribe request was processed successfully.\n   * @export\n   */\n  deleteToken(token: string): Promise<Boolean> {\n    return this.tokenDetailsModel_\n      .deleteToken(token)\n      .then(details => {\n        return this.iidModel_.deleteToken(\n          details['fcmSenderId'],\n          details['fcmToken'],\n          details['fcmPushSet']\n        );\n      })\n      .then(() => {\n        return this.getSWRegistration_()\n          .then(registration => {\n            if (registration) {\n              return registration.pushManager.getSubscription();\n            }\n          })\n          .then(subscription => {\n            if (subscription) {\n              return subscription.unsubscribe();\n            }\n          });\n      });\n  }\n\n  getSWRegistration_(): Promise<ServiceWorkerRegistration> {\n    throw this.errorFactory_.create(Errors.codes.SHOULD_BE_INHERITED);\n  }\n\n  getPublicVapidKey_(): Promise<Uint8Array> {\n    throw this.errorFactory_.create(Errors.codes.SHOULD_BE_INHERITED);\n  }\n\n  //\n  // The following methods should only be available in the window.\n  //\n\n  requestPermission() {\n    throw this.errorFactory_.create(Errors.codes.AVAILABLE_IN_WINDOW);\n  }\n\n  getPushSubscription_(\n    registration,\n    publicVapidKey\n  ): Promise<PushSubscription> {\n    throw this.errorFactory_.create(Errors.codes.AVAILABLE_IN_WINDOW);\n  }\n\n  /**\n   * @export\n   * @param {!ServiceWorkerRegistration} registration\n   */\n  useServiceWorker(registration) {\n    throw this.errorFactory_.create(Errors.codes.AVAILABLE_IN_WINDOW);\n  }\n\n  /**\n   * @export\n   * @param {!string} b64PublicKey\n   */\n  usePublicVapidKey(b64PublicKey) {\n    throw this.errorFactory_.create(Errors.codes.AVAILABLE_IN_WINDOW);\n  }\n\n  /**\n   * @export\n   * @param {!firebase.Observer|function(*)} nextOrObserver\n   * @param {function(!Error)=} optError\n   * @param {function()=} optCompleted\n   * @return {!function()}\n   */\n  onMessage(nextOrObserver, optError, optCompleted) {\n    throw this.errorFactory_.create(Errors.codes.AVAILABLE_IN_WINDOW);\n  }\n\n  /**\n   * @export\n   * @param {!firebase.Observer|function()} nextOrObserver An observer object\n   * or a function triggered on token refresh.\n   * @param {function(!Error)=} optError Optional A function\n   * triggered on token refresh error.\n   * @param {function()=} optCompleted Optional function triggered when the\n   * observer is removed.\n   * @return {!function()} The unsubscribe function for the observer.\n   */\n  onTokenRefresh(nextOrObserver, optError, optCompleted) {\n    throw this.errorFactory_.create(Errors.codes.AVAILABLE_IN_WINDOW);\n  }\n\n  //\n  // The following methods are used by the service worker only.\n  //\n\n  /**\n   * @export\n   * @param {function(Object)} callback\n   */\n  setBackgroundMessageHandler(callback) {\n    throw this.errorFactory_.create(Errors.codes.AVAILABLE_IN_SW);\n  }\n\n  //\n  // The following methods are used by the service themselves and not exposed\n  // publicly or not expected to be used by developers.\n  //\n\n  /**\n   * This method is required to adhere to the Firebase interface.\n   * It closes any currently open indexdb database connections.\n   */\n  delete() {\n    return Promise.all([\n      this.tokenDetailsModel_.closeDatabase(),\n      this.vapidDetailsModel_.closeDatabase()\n    ]);\n  }\n\n  /**\n   * Returns the current Notification Permission state.\n   * @private\n   * @return {string} The currenct permission state.\n   */\n  getNotificationPermission_() {\n    return (Notification as any).permission;\n  }\n\n  getTokenDetailsModel(): TokenDetailsModel {\n    return this.tokenDetailsModel_;\n  }\n\n  getVapidDetailsModel(): VapidDetailsModel {\n    return this.vapidDetailsModel_;\n  }\n\n  /**\n   * @protected\n   * @returns {IIDModel}\n   */\n  getIIDModel() {\n    return this.iidModel_;\n  }\n}\n"]}